<script>
        const body = document.body;
        const island = document.getElementById('dynamic-island');
        const timeDisplay = document.getElementById('vietnam-time');
        const islandContent = document.getElementById('island-content');
        const visualizerCanvas = document.getElementById('audio-visualizer');
        const youtubeLinkInput = document.getElementById('youtube-link-input');
        const loadVideoBtn = document.getElementById('load-video-btn');
        const videoPlayerDiv = document.getElementById('video-player');
        const changeAvatarBtn = document.getElementById('change-avatar-btn');
        const avatarImage = document.getElementById('avatar-image');
        const targetText = document.getElementById('target-text');
        const rainbowBtn = document.getElementById('rainbow-text-btn');
        const rgbBtn = document.getElementById('rgb-text-btn');
        const randomBtn = document.getElementById('random-text-btn');
        const toggleNightModeBtn = document.getElementById('toggle-night-mode-btn');
        const userNameSpan = document.getElementById('userName');
        const verifiedTickSpan = document.getElementById('verifiedTick');
        const nameColorInput = document.getElementById('name-color-input');
        const tickColorInput = document.getElementById('tick-color-input');

        let rgbInterval; 
        let isNightMode = false;
        let soundwaveColorInterval; // New interval for color cycling
        let hue = 0; // Starting hue for the soundwave

        // --- Night Mode Toggle ---
        toggleNightModeBtn.addEventListener('click', () => {
            isNightMode = !isNightMode;
            body.classList.toggle('night-mode', isNightMode);
            toggleNightModeBtn.textContent = isNightMode ? '‚òÄÔ∏è Light Mode' : 'üåô Night Mode';
            updateNameAndTickColors();
        });

        // --- Custom Name and Tick Color Update ---
        function updateNameAndTickColors() {
            userNameSpan.style.color = nameColorInput.value;
            const newTickColor = tickColorInput.value;
            const svgData = encodeURIComponent(`
                <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'>
                    <path fill='${newTickColor}' d='M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.707 7.707-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 1 1 1.414-1.414L11.5 12.086l3.293-3.293a1 1 0 0 1 1.414 1.414z'/>
                </svg>
            `);
            verifiedTickSpan.style.backgroundImage = `url("data:image/svg+xml,${svgData}")`;
        }

        nameColorInput.addEventListener('input', updateNameAndTickColors);
        tickColorInput.addEventListener('input', updateNameAndTickColors);
        updateNameAndTickColors();

        // --- 1. Dynamic Island Logic (Soundwave Color & Toggle) ---

        function updateSoundwaveColor() {
            hue = (hue + 2) % 360; // Increment hue by 2 for a smooth cycle
            const color1 = `hsl(${hue}, 100%, 50%)`;
            const color2 = `hsl(${(hue + 60) % 360}, 100%, 50%)`; // Secondary color offset
            const color3 = `hsl(${(hue + 120) % 360}, 100%, 50%)`; // Tertiary color offset

            // Apply the flowing rainbow using a CSS background gradient
            visualizerCanvas.style.backgroundImage = `linear-gradient(to right, ${color1}, ${color2}, ${color3}, ${color2}, ${color1})`;
        }

        function startSimulatedSoundwave() {
            visualizerCanvas.style.display = 'block'; 
            visualizerCanvas.classList.add('simulated-soundwave');
            
            // Start the color cycling effect if not already running
            if (!soundwaveColorInterval) {
                soundwaveColorInterval = setInterval(updateSoundwaveColor, 100); // Update color every 100ms
            }
        }
        
        function stopSimulatedSoundwave() {
            clearInterval(soundwaveColorInterval);
            soundwaveColorInterval = null;
            visualizerCanvas.classList.remove('simulated-soundwave');
            visualizerCanvas.style.display = 'none';
        }

        island.addEventListener('click', () => {
            island.classList.toggle('island-collapsed');
            island.classList.toggle('island-expanded');
            
            const isExpanded = island.classList.contains('island-expanded');
            
            if (isExpanded) {
                timeDisplay.style.display = 'block';
                if (videoPlayerDiv.querySelector('iframe')) {
                    // Start soundwave only if expanded AND video is loaded
                    startSimulatedSoundwave();
                }
            } else {
                // Stop soundwave when collapsed
                stopSimulatedSoundwave();
            }
        });

        // --- 2. Vietnam Time Display ---
        function updateVietnamTime() {
            const options = { 
                timeZone: 'Asia/Ho_Chi_Minh', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: false 
            };
            const vnTime = new Date().toLocaleTimeString('en-US', options);
            timeDisplay.textContent = vnTime;
        }

        updateVietnamTime();
        setInterval(updateVietnamTime, 1000); 

        // --- 3. YouTube Video Player and Link Loader ---
        loadVideoBtn.addEventListener('click', () => {
            const link = youtubeLinkInput.value.trim();
            if (!link) {
                alert('Please paste a valid YouTube link.');
                return;
            }

            let videoId;
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = link.match(regex);

            if (match && match[1]) {
                videoId = match[1];
            } else {
                videoPlayerDiv.innerHTML = `<p style="color: red;">Invalid YouTube link format.</p>`;
                return;
            }

            const iframeHTML = `<iframe width="100%" height="200" 
                src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" 
                frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen></iframe>`;
                
            videoPlayerDiv.innerHTML = iframeHTML;
            
            // Ensure soundwave starts and is visible if the island is currently expanded
            if (island.classList.contains('island-expanded')) {
                startSimulatedSoundwave(); 
            }
        });

        // --- 4. Avatar Changer ---
        changeAvatarBtn.addEventListener('click', () => {
            const newURL = prompt('Enter the new image URL for your Facebook avatar:');
            
            if (newURL) {
                avatarImage.src = newURL;
            }
        });

        // --- 5. Text Color Manipulation Functions ---
        function resetText() {
            clearInterval(rgbInterval); 
            targetText.innerHTML = targetText.textContent; 
            targetText.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color'); 
        }

        // A. Rainbow Text (Static Gradient)
        function setRainbowText(element) {
            resetText();
            const text = element.textContent;
            element.innerHTML = [...text].map((char, i) => {
                const hue = i * (360 / text.length);
                return `<span style="color: hsl(${hue}, 100%, 50%);">${char}</span>`;
            }).join('');
        }

        // B. RGB Cycle Text (Animated)
        function setRgbCycleText(element) {
            resetText();
            let step = 0;

            rgbInterval = setInterval(() => {
                const text = element.textContent;
                element.innerHTML = [...text].map((char, i) => {
                    const r = Math.sin(0.1 * i + step) * 127 + 128;
                    const g = Math.sin(0.1 * i + step + 2) * 127 + 128;
                    const b = Math.sin(0.1 * i + step + 4) * 127 + 128;
                    
                    return `<span style="color: rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)});">${char}</span>`;
                }).join('');
                
                step += 0.1; 
            }, 50); 
        }

        // C. Random Color Text (Static Random)
        function setRandomText(element) {
            resetText();
            const text = element.textContent;
            
            const randomColor = () => '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');

            element.innerHTML = [...text].map((char) => {
                return `<span style="color: ${randomColor()};">${char}</span>`;
            }).join('');
        }

        // Attach Event Listeners to Buttons
        rainbowBtn.addEventListener('click', () => setRainbowText(targetText));
        rgbBtn.addEventListener('click', () => setRgbCycleText(targetText));
        randomBtn.addEventListener('click', () => setRandomText(targetText));
    </script>
